# ispeakai - AG-UI Testing MVP

> **Status:** ✅ Implemented

## Technology Stack

### Primary Language: TypeScript + Node.js

**Rationale:**

- Official `@ag-ui/client` library available
- Excellent YAML parsing libraries
- Strong typing for assertion logic
- Familiar to most AG-UI developers
- Good CLI tooling ecosystem

### Core Dependencies

| Purpose           | Library         | Why                                                    |
| ----------------- | --------------- | ------------------------------------------------------ |
| AG-UI client      | `@ag-ui/client` | Official library, handles SSE parsing and reconnection |
| CLI framework     | `commander`     | Lightweight, well-documented, TypeScript support       |
| YAML parsing      | `js-yaml`       | De facto standard, full YAML 1.2 support               |
| Schema validation | `zod`           | Runtime validation with TypeScript inference           |
| Test runner       | `vitest`        | Fast, ESM-native, good DX for internal tests           |
| Process execution | `execa`         | Better child process handling for hooks                |
| Colors/output     | `picocolors`    | Minimal, fast terminal colors                          |

### Project Structure (Actual)

```
ispeakai/
├── src/
│   ├── cli/
│   │   ├── index.ts              # Entry point
│   │   └── commands/
│   │       └── run.ts            # Main test runner command
│   ├── config/
│   │   ├── index.ts              # Exports
│   │   ├── loader.ts             # Load ispeakai.config.yaml
│   │   ├── test-loader.ts        # Load test YAML files
│   │   └── interpolate.ts        # Variable interpolation (${VAR}, ${ENV.X})
│   ├── hooks/
│   │   ├── index.ts              # Exports
│   │   └── executor.ts           # Run preflight hooks, parse JSON output
│   ├── client/
│   │   ├── index.ts              # Exports
│   │   ├── agui.ts               # AG-UI client using @ag-ui/client
│   │   └── events.ts             # Event type definitions
│   ├── runner/
│   │   ├── index.ts              # Exports
│   │   ├── test.ts               # Single test file executor
│   │   └── turn.ts               # Turn execution logic
│   ├── assertions/
│   │   ├── index.ts              # Exports
│   │   ├── engine.ts             # Assertion evaluation engine
│   │   ├── tools.ts              # Tool-related assertions
│   │   ├── tools.test.ts         # Unit tests
│   │   ├── timing.ts             # Timing assertions
│   │   ├── timing.test.ts        # Unit tests
│   │   ├── text.ts               # Text regex assertions
│   │   ├── text.test.ts          # Unit tests
│   │   └── types.ts              # AssertionResult type
│   └── types/
│       ├── index.ts              # Exports
│       ├── config.ts             # ProjectConfig schema
│       ├── test.ts               # TestFile, AssertBlock schemas
│       └── data.ts               # TurnData, ToolCall types
├── examples/
│   └── *.test.yaml               # Example test files
├── package.json
├── tsconfig.json
├── tsup.config.ts
└── README.md
```

---

## Implementation Phases

### Phase 1: Foundation ✅

**Goal:** Basic CLI that loads config and test files.

- [x] Project setup with TypeScript + ESM + tsup
- [x] Config loader with file discovery (`ispeakai.config.yaml`)
- [x] Zod schemas for config and test files
- [x] Test file parser with glob pattern support
- [x] Variable interpolation (`${VAR}`, `${ENV.NAME}`)
- [x] CLI with `run` command, `--config`, `--verbose`, `--dry-run` flags

---

### Phase 2: Execution Engine ✅

**Goal:** Execute hooks and connect to AG-UI endpoint.

- [x] Hook executor with JSON output parsing
- [x] Timeout and error handling for hooks
- [x] Variable system merging hook outputs + ENV
- [x] AG-UI client using `@ag-ui/client` library
- [x] CopilotKit single-route transport format support
- [x] Turn execution with event collection
- [x] Retry logic when no events received

---

### Phase 3: Data Collection ✅

**Goal:** Capture and structure all observable data.

- [x] Tool call collection (name, args, result, timestamp)
- [x] Assistant text accumulation
- [x] Turn data structure with boundaries
- [x] Test data aggregation across turns

---

### Phase 4: Assertion Engine ✅

**Goal:** Evaluate all assertion types.

- [x] Tool assertions: `forbid`, `require`, `count`, `args_match`, `result_match`, `after`, `forbid_calls`
- [x] Timing assertions: `max_duration_ms`, `max_gap_ms`
- [x] Text assertions: `must_match`, `must_not_match`
- [x] Turn-level assertions with fail-fast
- [x] Test-level assertions after all turns
- [x] Clear failure messages with expected/actual values

---

### Phase 5: Runner & Reporter ✅

**Goal:** Orchestrate test execution and report results.

- [x] Test runner with hooks → turns → assertions flow
- [x] Multi-file runner with glob patterns
- [x] Console reporter with colors
- [x] CI reporter with JSON output (`--json` flag)
- [x] Exit codes (0 = pass, 1 = fail)

---

### Phase 6: Polish & Documentation ✅

**Goal:** Production-ready MVP.

- [x] README with quick start and reference
- [x] Unit tests for assertions (26 tests)
- [x] Example test files

---

## Key Implementation Details

### AG-UI Client

Uses the official `@ag-ui/client` library:

```typescript
import {
  randomUUID,
  runHttpRequest,
  transformHttpEventStream,
} from "@ag-ui/client";
```

**Features:**

- CopilotKit single-route transport format (envelope with `method`, `params`, `body`)
- Observable-based event streaming
- Automatic retry when no events received
- Proper SSE parsing via official library

### CopilotKit Transport Format

```typescript
const envelope = {
  method: "agent/run",
  params: { agentId: this.agentId },
  body: {
    threadId: options.threadId,
    runId: randomUUID(),
    messages: [{ id: randomUUID(), role: "user", content: message }],
    forwardedProps: options.forwardedProps,
  },
};
```

### AG-UI Event Types

```typescript
type AGUIEvent =
  | { type: "RUN_STARTED"; runId: string; threadId?: string }
  | { type: "TEXT_MESSAGE_START"; messageId: string; role: "assistant" }
  | { type: "TEXT_MESSAGE_CONTENT"; messageId: string; delta: string }
  | { type: "TEXT_MESSAGE_END"; messageId: string }
  | { type: "TOOL_CALL_START"; toolCallId: string; toolCallName: string }
  | { type: "TOOL_CALL_ARGS"; toolCallId: string; delta: string }
  | { type: "TOOL_CALL_END"; toolCallId: string }
  | { type: "TOOL_CALL_RESULT"; toolCallId: string; result: string }
  | { type: "RUN_FINISHED"; runId: string }
  | { type: "RUN_ERROR"; runId: string; message: string; code?: string };
```

### Variable Interpolation

```typescript
function interpolate(template: string, vars: Record<string, string>): string {
  return template.replace(/\$\{(ENV\.)?(\w+)\}/g, (_, isEnv, name) => {
    if (isEnv) return process.env[name] ?? "";
    return vars[name] ?? "";
  });
}
```

### Assertion Result Type

```typescript
interface AssertionResult {
  passed: boolean;
  assertion: string; // Human-readable description
  expected?: string;
  actual?: string;
  details?: string;
}
```

---

## Configuration

### Project Config (`ispeakai.config.yaml`)

```yaml
target:
  endpoint: "https://app.example.com/ag-ui"
  headers:
    Authorization: "Bearer ${ENV.AGUI_TOKEN}"
  agentId: "my-agent" # Optional, for CopilotKit transport
```

---

## CLI Usage

```bash
# Run all tests
ispeakai run

# Run specific tests
ispeakai run tests/*.test.yaml

# Dry run (validate only)
ispeakai run --dry-run

# JSON output for CI
ispeakai run --json

# Verbose output
ispeakai run -v
```

---

## Future Enhancements (Out of Scope for MVP)

- Parallel test execution
- MCP/A2A adapters
- LLM-as-judge assertions
- Semantic text evaluation
- Web UI / dashboard
- Test recording/playback
- Snapshot testing
