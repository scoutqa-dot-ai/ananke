name: checkout flow with validation

hooks:
  - cmd: ["echo", "{\"THREAD_ID\": \"th_123\"}"]
    timeout_ms: 10000

turns:
  - user: "I want to checkout"
    assert:
      tools:
        require:
          - name: validate_cart
          - name: get_shipping_options
            after: validate_cart
      timing:
        max_duration_ms: 30000

  - user: "Use the first shipping option"
    assert:
      tools:
        require:
          - name: calculate_total
            result_not_match: "error|failed"

  - user: "Confirm and pay"
    assert:
      tools:
        require:
          - name: charge_card
            count: { exact: 1 }
        forbid_calls:
          - name: charge_card
            result_match: "declined|insufficient"

assert:
  tools:
    forbid:
      - delete_order
  timing:
    max_duration_ms: 120000
    max_gap_ms: 60000
